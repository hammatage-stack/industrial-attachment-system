name: Build and Push to ECR

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  AWS_REGION: us-east-1  # Change to your region
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  BACKEND_REPO: industrial-attachment-backend
  FRONTEND_REPO: industrial-attachment-frontend

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      backend-image-tag: ${{ steps.image-tag.outputs.backend-tag }}
      frontend-image-tag: ${{ steps.image-tag.outputs.frontend-tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Generate image tag
        id: image-tag
        run: |
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKEND_TAG="${SHORT_SHA}-${TIMESTAMP}"
          FRONTEND_TAG="${SHORT_SHA}-${TIMESTAMP}"
          
          echo "backend-tag=${BACKEND_TAG}" >> $GITHUB_OUTPUT
          echo "frontend-tag=${FRONTEND_TAG}" >> $GITHUB_OUTPUT
          
          echo "Backend Tag: ${BACKEND_TAG}"
          echo "Frontend Tag: ${FRONTEND_TAG}"
      
      - name: Build Backend Docker image
        working-directory: ./backend
        run: |
          docker build \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ steps.image-tag.outputs.backend-tag }} \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .
      
      - name: Build Frontend Docker image
        working-directory: ./frontend
        run: |
          docker build \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ steps.image-tag.outputs.frontend-tag }} \
            --tag ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            --build-arg VCS_REF=${{ github.sha }} \
            .
      
      - name: Scan Backend image for vulnerabilities
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ steps.image-tag.outputs.backend-tag }}
      
      - name: Scan Frontend image for vulnerabilities
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL \
            --exit-code 0 \
            ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ steps.image-tag.outputs.frontend-tag }}
      
      - name: Push Backend image to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ steps.image-tag.outputs.backend-tag }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:latest
      
      - name: Push Frontend image to ECR
        run: |
          docker push ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ steps.image-tag.outputs.frontend-tag }}
          docker push ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:latest
      
      - name: Create image tags file
        run: |
          cat > image-tags.txt << EOF
          BACKEND_IMAGE=${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ steps.image-tag.outputs.backend-tag }}
          FRONTEND_IMAGE=${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ steps.image-tag.outputs.frontend-tag }}
          COMMIT_SHA=${{ github.sha }}
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          EOF
          
          cat image-tags.txt
      
      - name: Upload image tags artifact
        uses: actions/upload-artifact@v3
        with:
          name: image-tags
          path: image-tags.txt
      
      - name: Comment PR with image tags
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const output = `### ðŸ³ Docker Images Built Successfully
            
            **Backend Image:**
            \`\`\`
            ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ steps.image-tag.outputs.backend-tag }}
            \`\`\`
            
            **Frontend Image:**
            \`\`\`
            ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ steps.image-tag.outputs.frontend-tag }}
            \`\`\`
            
            **Commit:** ${{ github.sha }}
            
            Update your GitOps repo with these image tags for deployment.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  notify-gitops:
    name: Notify GitOps Repo
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Trigger GitOps repo update
        run: |
          echo "ðŸš€ New images are ready for deployment:"
          echo "Backend: ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ needs.build-and-push.outputs.backend-image-tag }}"
          echo "Frontend: ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ needs.build-and-push.outputs.frontend-image-tag }}"
          echo ""
          echo "ðŸ“ Update your GitOps repository with these image tags"
          echo "ArgoCD will automatically detect changes and deploy"
      
      # Optional: Auto-create PR in GitOps repo
      - name: Create PR in GitOps repo (Optional)
        if: secrets.GITOPS_REPO_TOKEN != ''
        run: |
          # This would create a PR in your GitOps repo with updated image tags
          # Requires GITOPS_REPO_TOKEN secret
          echo "Auto-PR creation would go here"
